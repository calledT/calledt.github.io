<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>兼容IE、Chrome、FF的图片上传前预览 &#8211; T 馆</title>
<meta name="description" content="图片上传前预览，兼容所有浏览器">
<meta name="keywords" content="IE, 图片预览">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="兼容IE、Chrome、FF的图片上传前预览">
<meta property="og:description" content="图片上传前预览，兼容所有浏览器">
<meta property="og:url" content="/previrew-image-before-upload/">
<meta property="og:site_name" content="T 馆">





<link rel="canonical" href="/previrew-image-before-upload/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="T 馆 Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://browsehappy.com/">亲，你的浏览器似乎过时啦!</strong> 去挑一个炫酷炸叼天的试试吧！</a></div><![endif]-->

<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
  <button class="dl-trigger">Open Menu</button>
  <ul class="dl-menu">
    <li><a href="">首页</a></li>
    <li>
      <a href="#">关于我</a>
      <ul class="dl-submenu">
        <li>
          <img src="/images/avator-gray.jpg" alt="Kimi photo" class="author-photo">
          <h4>Kimi</h4>
          <p>一Cl 一Editor 一世界</p>
        </li>
        <li><a href="/about/">Learn More</a></li>
        
          <li><a href="https://github.com/calledT"><i class="iconfont icon-github"></i> github</a></li>
        
          <li><a href="http://weibo.com/huanggengtao"><i class="iconfont icon-weibo"></i> weibo</a></li>
        
          <li><a href="https://twiter.com/huanggengtao"><i class="iconfont icon-twitter"></i> twitter</a></li>
        
          <li><a href="https://fackbook.com/huanggengtao"><i class="iconfont icon-facebook"></i> facebook</a></li>
        
      </ul>
    </li>
    <li>
      <a href="#">文章</a>
      <ul class="dl-submenu">
        <li><a href="/posts/">所有文章</a></li>
        <li><a href="/tags/">所有标签</a></li>
      </ul>
    </li>
    
      
          
          
      <li><a href="http://www.html-js.com/" target="_blank">前端乱炖</a></li>
    
      
          
          
      <li><a href="http://www.v2ex.com/" target="_blank">V2EX</a></li>
    
      
          
          
      <li><a href="http://www.css88.com/" target="_blank">WEB前端开发</a></li>
    
  </ul><!-- /.dl-menu -->
</nav><!-- /.dl-menuwrapper -->



<div class="entry-header">
  
    <div class="image-credit">Image source: 
      <a href="http://www.dargadgetz.com/ios-7-abstract-wallpaper-pack-for-iphone-5-and-ipod-touch-retina/">dargadgetz</a>
    </div><!-- /.image-credit -->
  
  <div class="entry-image">
    <img src="/images/abstract-4.jpg" alt="兼容IE、Chrome、FF的图片上传前预览">
  </div><!-- /.entry-image -->
</div><!-- /.entry-header -->


<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title">
            <a href="/previrew-image-before-upload/" rel="bookmark" title="兼容IE、Chrome、FF的图片上传前预览">兼容IE、Chrome、FF的图片上传前预览</a>
          </h1>
        
        <h2>2015-01-06</h2>
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <h3 id="section">原由</h3>

<p>  最近在帮同事解决一个图片显示的问题，情形是这样的。图片通过异步上传，成功后返回一个图片的链接，再把这个链接赋给<code>img</code>标签的<code>src</code>属性，但这个过程会间歇性的出现<code>404</code>错误。
<!-- more --></p>

<p>  <code>404</code>我们知道是访问一个不存在的链接，但在浏览器中直接访问这个链接，又是可以的。反复排查了前端代码和后端代码，也没发现有错误的地方。再经过一番深入了解，知道上传图片的功能用的是内网的一个文件系统<a href="https://code.google.com/p/fastdfs" title="fastdfs" target="_blank">fasetdfs</a>，于是就想会不会是磁盘快满了才会出现这个问题，以前遇到过<a href="http://www.mysql.com" title="mysql" target="_blank">mysql</a>所在服务器因磁盘空间不够出现过各种诡异问题。</p>

<p>  从负责这个文件系统架设的工程师那里拿到说是文件系统所在服务器的<code>IP</code>后就上去查磁盘空间大小（当时自己也不了解这个文件系统，以为这个 IP 所在的服务器就是存放文件的地方），看着磁盘空间还剩很多，就带着疑惑上网查找，发现那个工程师给我的并不是最终存放文件的服务器，只是<a href="http://nginx.org" title="nginx" target="_blank">nginx</a>所在的机器，在打开<code>nginx.conf</code>看到配置后，就一切明了了。</p>

<p>  原来最终存放文件的是两台机器，<a href="http://nginx.org" title="nginx" target="_blank">nginx</a>担任负载均衡作用，而负载策略是随机的。随机的负载策略加上文件系统同步文件的时间差，就造成了上传响应成功，设置<code>img</code>标签的<code>src</code>属性出现<code>404</code>想象。</p>

<p>解决的办法就是<a href="http://nginx.org" title="nginx" target="_blank">nginx</a>根据<code>IP</code>去负载或者设置文件系统为主从，根据我们的业务需求选择了主从。</p>

<h3 id="section-1">图片上传前预览代码</h3>

<p>  回过头想了想，发现这地方其实存在交互不合理的地方，正确的做法应该是图片在上传前可以预览，而不是一选择图片就上传然后返回图片的链接回来。所以写了以下兼容所有浏览器的图片上传前预览的代码。</p>

<pre class="codepen" data-height="400" data-type="result" data-href="ZYBZze" data-user="calledT" data-safe="true">
    <code></code>
    <a href="http://codepen.io/calledT/embed/ZYBZze/">Check out this Pen!</a> 
</pre>
<script async="" src="http://codepen.io/assets/embed/ei.js"> </script>

<h4 id="section-2">参考链接：</h4>
<ul>
  <li><a href="http://forums.asp.net/t/1320559.aspx" target="_blank">How to Preview image before Upload</a></li>
  <li><a href="http://stackoverflow.com/questions/4459379/preview-an-image-before-it-is-uploaded?rq=1" target="_blank">Preview an image before it is uploaded</a></li>
</ul>


      <footer class="entry-meta">
        <span class="entry-tags">
          
            <a href="/tags/#IE" title="Pages tagged IE" class="tag">IE</a>
          
            <a href="/tags/#图片预览" title="Pages tagged 图片预览" class="tag">图片预览</a>
          
        </span>
        <span>
          <a href="/previrew-image-before-upload/" rel="bookmark" title="兼容IE、Chrome、FF的图片上传前预览">兼容IE、Chrome、FF的图片上传前预览</a> was published on
          <span class="entry-date date published updated">
            <time datetime="2015-01-06T00:00:00+08:00">January 06, 2015</time>
          </span>
        </span>
        
          (revised: <span class="entry-date date modified">
            <time datetime="2015-01-06">01/06/2015</time>
          </span>)
        
        <span class="author vcard">
          <span class="fn">
            <a href="/about/" title="About Kimi">Kimi</a>
          </span>
        </span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li>
      <a class="jiathis_button_tsina" title="分享到新浪微博"><i class="iconfont icon-weibo-square"></i></a>
    </li>
    <li>
      <a class="jiathis_button_weixin" title="分享到微信"><i class="iconfont icon-weixin-square"></i></a>
    </li>
    <li>
      <a class="jiathis_button_renren" title="分享到人人网"><i class="iconfont icon-renren-square"></i></a>
    </li>
    <li>
      <a class="jiathis_button_qzone" title="分享QQ空间"><i class="iconfont icon-qzone-square"></i></a>
    </li>
    <li>
      <a class="jiathis_button_douban" title="分享到豆瓣网"><i class="iconfont icon-douban-square"></i></a>
    </li>
  </ul>
</div>


      </footer>
    </div><!-- /.entry-content -->

    
      
      <div class="ds-thread"></div>
      
    

    <div class="read-more">
  
    <div class="read-more-header">
      <a href="/sublimelinter-in-action/" class="read-more-btn">更多内容</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="/sublimelinter-in-action/" title="SublimeLinter实践">SublimeLinter实践</a></h3>
      <p>sublimelinter在工程中的实际应用 <a href="/sublimelinter-in-action/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="/front-end-automation-browsersync-livereload/" title="前端自动化工程之浏览器同步更新">前端自动化工程之浏览器同步更新</a></h4>
        <span>Published on December 27, 2014</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="/about-autologin/" title="自动登陆那点事">自动登陆那点事</a></h4>
        <span>Published on November 24, 2014</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->

  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>
  &copy; 2015 Kimi.
  Powered by <a href="http://jekyllrb.com">Jekyll</a>
  design by <a href="https://mademistakes.com">Michael Rose</a>.
</span>

  </footer>
</div><!-- /.footer-wrapper -->

<script src="//libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>



<!-- jiathis 分享 -->
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>




<!-- 百度统计异步代码 -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?f85720f7b69b6aa1f1dbfcaeea5ae412";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>






<script type="text/javascript">
  var duoshuoQuery = {short_name: 'calledt'};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';
    ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>




</body>
</html>
